# PYTHON-7. Объединение таблиц

## 7.1 Цели и ожидаемые результаты
В этом модуле мы познакомимся с объединением датафреймов и работой с множеством файлов.
На практике источники данных редко ограничиваются одной таблицей.  Что делать, если надо объединить несколько?

1. merge - аналог SQL Join, позволяет аналогичным образом объединять датафреймы, используя для объединения один
или несколько общих столбцов таблиц.
1. Python имеет простые и удобные инструменты для обхода папок и импорта выгрузок в единый датафрейм,
что существенно облегчает работу с данными 


## 7.2 С какими данными работаем
**ratings.csv** - данные о выставленных оценках фильмов.
* userId — идентификатор пользователя, который поставил фильму оценку,
* movieId — идентификатор фильма,
* rating — выставленная оценка,
* timestamp — время (в формате unix time), когда была выставлена оценка.

**movies.csv** - расшифровка идентификаторов фильмов.
* movieId — идентификатор фильма,
* title — название фильма,
* genres — список жанров, к которым относится фильм.


## 7.3 Тестовые вопросы
```python
import pandas as pd


df_ratings = pd.read_csv('ratings.csv')
print('Количество строк в файле рейтингов:', df_ratings['rating'].count())
print('Минимальная оценка:', df_ratings['rating'].min())
print('Максимальная оценка:', df_ratings['rating'].max())
```


## 7.4 Структура и требования
Полезные ссылки:
1. [Пример режимов склейки таблиц](https://pandas.pydata.org/pandas-docs/stable/user_guide/merging.html)
1. [Документация по методу merge](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.merge.html)
1. [Объяснение SQL объединений JOIN: LEFT/RIGHT/INNER/OUTER](http://www.skillz.ru/dev/php/article-Obyasnenie_SQL_obedinenii_JOIN_INNER_OUTER.html)


# 7.5 Зачем хранить информацию в разных таблицах
1. Часто данные формируются несколькими независимыми процессами, каждый из которых хранит данные в своей таблице.
Например, данные для отчета по продажам могут состоять из списка банковских транзакций, курсов валют от Центробанка
и планов отдела продаж из внутренней CRM. 
1. Хранить все данные в одной таблице часто очень накладно для ёмкости диска.
Например, названия фильмов в наших данных хранятся в отдельной небольшой таблице. А в логах, которые могут
растягиваться на многие миллионы строк, вместо названия фильма стоит его идентификатор. Числовой идентификатор фильма
занимает на диске гораздо меньше места, чем длинное название.


## 7.6 Информация про данные
```python
import pandas as pd


df_movies = pd.read_csv('movies.csv')
print('Количество фильмов в таблице movies:', df_movies['movieId'].count())
```


## 7.7 Объединяем таблицы
У датафреймов ratings и movies есть общий столбец movieId.
Мы можем объединить эти датафреймы в одну таблицу по этому столбцу. 

```python
import pandas as pd


ratins = pd.read_csv('ratings.csv')
movies = pd.read_csv('movies.csv')
joined = ratins.merge(movies, on='movieId', how='left')
print(joined)
```

Схематично `joined = left_df.merge(right_df, on='', how='')`

**how** - параметр объединения записей. Он может иметь четыре значения: left, right, inner и outer.  
При значении left берем все записи (movieId) из "левого" датафрейма (ratings) и ищем их соответствия в "правом" (movies).
В итоговом датафрейме останутся только те значения, которым были найдены соответствия, то есть только значения из ratings.
Аналогично при параметре right остаются только значения из "правого" датафрейма.
Если совпадений между таблицами нет, то ставим нулевое значение.
Значение inner оставляет только те записи (movieId), которые есть в обоих датафреймах, outer объединяет все варианты movieId в обоих датафреймах.


## 7.8 Трудности объединения датафреймов
Объединение датафреймов с помощью метода merge имеет особенности, аналогичные SQL JOIN.
Если точнее, есть ситуации, которые приводят к дублированию строк в конечном результате.
